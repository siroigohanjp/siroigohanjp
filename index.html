<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ローグライク（広めマップ）</title>
<style>
body { font-family: sans-serif; display: flex; flex-direction: column; align-items: center; margin:0; padding:10px;}
#status{margin-bottom:10px;padding:5px;border:1px solid #333;background:#eee;width:90vw;max-width:500px;font-size:14px;white-space:pre-wrap;}
#game{display:grid;grid-template-columns:repeat(10,1fr);width:90vw;max-width:500px;background:#333;}
.cell{display:flex;align-items:center;justify-content:center;font-size:20px;aspect-ratio:1/1;}
.wall{background:#555;color:#555;}
#log{margin-top:10px;width:90vw;max-width:500px;height:140px;overflow-y:auto;border:1px solid #333;padding:5px;font-size:14px;background:#eee;white-space:pre-wrap;}
#controls{margin-top:15px;display:grid;grid-template-columns:repeat(3,70px);grid-template-rows:repeat(3,70px);gap:5px;justify-content:center;}
#controls button,#battle button,#itemButton{font-size:18px;border-radius:10px;padding:5px;}
#controls .empty{background:transparent;border:none;}
#battle{margin-top:15px;display:none;grid-template-columns:repeat(2,120px);gap:5px;justify-content:center;}
#itemButton{margin-top:10px;}
</style>
</head>
<body>

<div id="status"></div>
<div id="game"></div>
<div id="log"></div>

<div id="controls">
  <div></div><button onclick="move(0,-1)">↑</button><div></div>
  <button onclick="move(-1,0)">←</button><div class="empty"></div><button onclick="move(1,0)">→</button>
  <div></div><button onclick="move(0,1)">↓</button><div></div>
</div>
<button id="itemButton" onclick="useItem()">薬草を使う</button>

<div id="battle">
  <button onclick="battleAction('attack')">こうげき</button>
  <button onclick="battleAction('defend')">ぼうぎょ</button>
  <button onclick="battleAction('item')">アイテム</button>
  <button onclick="battleAction('escape')">にげる</button>
</div>

<script>
const size=10;
let player={x:0,y:0,hp:20,atk:5,def:2,spd:5,exp:0,bag:[],bagSize:5};
let floor=1;
let map=[],currentEnemy=null,enemyPos=null,inBattle=false;
let logEl=document.getElementById('log'),gameEl=document.getElementById('game');
let controlsEl=document.getElementById('controls'),battleEl=document.getElementById('battle');
let statusEl=document.getElementById('status');

function log(msg){logEl.innerText+=msg+'\n';logEl.scrollTop=logEl.scrollHeight;}
function updateStatus(){statusEl.innerText=`階層:${floor}\nHP:${player.hp} ATK:${player.atk} DEF:${player.def} SPD:${player.spd} EXP:${player.exp}\nバッグ:${player.bag.length}/${player.bagSize}`;}

function createEnemy(){
  const types=[
    {name:"スライム",hp:[8,15],atk:[2,4],def:[0,1],spd:[1,3],exp:[3,6]},
    {name:"ゴブリン",hp:[10,18],atk:[3,6],def:[1,2],spd:[2,4],exp:[5,8]},
    {name:"オオカミ",hp:[9,14],atk:[3,5],def:[1,2],spd:[4,7],exp:[6,9]},
    {name:"バット",hp:[6,12],atk:[2,4],def:[0,1],spd:[5,8],exp:[5,7]},
    {name:"スケルトン",hp:[12,18],atk:[3,5],def:[2,4],spd:[2,3],exp:[7,10]},
    {name:"マジシャン",hp:[8,12],atk:[5,8],def:[1,2],spd:[3,5],exp:[8,12]},
    {name:"トロル",hp:[18,25],atk:[6,9],def:[2,3],spd:[1,2],exp:[10,14]},
    {name:"バンパイア",hp:[14,20],atk:[5,7],def:[2,3],spd:[3,5],exp:[12,16]},
    {name:"ゴーレム",hp:[20,30],atk:[4,6],def:[5,8],spd:[1,2],exp:[15,20]},
    {name:"ドラゴン",hp:[30,40],atk:[8,12],def:[4,6],spd:[4,6],exp:[30,40]}
  ];
  let weights=types.map((e,i)=>Math.max(1,floor-i+2));
  let total=weights.reduce((a,b)=>a+b,0);
  let r=Math.random()*total; let idx=0;
  for(let i=0;i<weights.length;i++){if(r<weights[i]){idx=i;break;} r-=weights[i];}
  let t=types[idx]; function rand(r){return Math.floor(Math.random()*(r[1]-r[0]+1))+r[0];}
  return {name:t.name,hp:rand(t.hp),atk:rand(t.atk),def:rand(t.def),spd:rand(t.spd),exp:rand(t.exp)};
}

function generateMap(){
  map=[]; 
  for(let y=0;y<size;y++){map[y]=[];for(let x=0;x<size;x++){map[y][x]='#';}}

  // プレイヤー位置
  player.x=Math.floor(size/2); 
  player.y=Math.floor(size/2);
  map[player.y][player.x]='.';

  // 階段位置
  let stairsX, stairsY;
  do{
    stairsX=Math.floor(Math.random()*size);
    stairsY=Math.floor(Math.random()*size);
  }while(stairsX===player.x && stairsY===player.y);

  // 必達経路
  let cx = player.x, cy = player.y;
  while(cx !== stairsX || cy !== stairsY){
    if(cx < stairsX) cx++; else if(cx > stairsX) cx--;
    else if(cy < stairsY) cy++; else if(cy > stairsY) cy--;
    map[cy][cx]='.';
  }
  map[stairsY][stairsX]='>';

  // 広めランダムウォークで通路拡張
  for(let i=0;i<10;i++){ // 10本ウォーク
    let x = Math.floor(Math.random()*size);
    let y = Math.floor(Math.random()*size);
    for(let j=0;j<15;j++){ // 各ウォーク15歩
      map[y][x]='.';
      let dir=Math.floor(Math.random()*4);
      if(dir===0 && y>0) y--;
      else if(dir===1 && y<size-1) y++;
      else if(dir===2 && x>0) x--;
      else if(dir===3 && x<size-1) x++;
    }
  }

  // 敵・薬草配置
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      if(map[y][x]==='.' && Math.random()<0.08) map[y][x]='M';
      else if(map[y][x]==='.' && Math.random()<0.04) map[y][x]='+';
    }
  }

  map[player.y][player.x]='@'; // プレイヤー
}

function drawMap(){
  gameEl.innerHTML='';
  for(let y=0;y<size;y++){
    for(let x=0;x<size;x++){
      let cell=document.createElement('div');cell.className='cell';
      if(map[y][x]==='#') cell.className+=' wall';
      cell.textContent=map[y][x];
      gameEl.appendChild(cell);
    }
  }
  updateStatus();
}

function move(dx,dy){
  if(inBattle) return;
  let nx=player.x+dx,ny=player.y+dy;
  if(nx<0||ny<0||nx>=size||ny>=size) return;
  let cell=map[ny][nx];

  if(cell==='#') return; // 壁通行不可
  if(cell==='>'){floor++; log(`階段を降りて階層${floor}へ！`); generateMap(); drawMap(); return;}
  if(cell==='M'){currentEnemy=createEnemy(); enemyPos={x:nx,y:ny}; inBattle=true; controlsEl.style.display='none'; document.getElementById("itemButton").style.display='none'; battleEl.style.display='grid';
    log(`敵「${currentEnemy.name}」が現れた！`); 
    log(`【敵ステータス】 HP:${currentEnemy.hp} ATK:${currentEnemy.atk} DEF:${currentEnemy.def} SPD:${currentEnemy.spd} EXP:${currentEnemy.exp}`);
    return;}
  if(cell==='+'){if(player.bag.length<player.bagSize){player.bag.push("薬草");log("薬草を拾った！（バッグ"+player.bag.length+"/"+player.bagSize+"）");} else{log("バッグがいっぱいで薬草を拾えない！");}}

  map[player.y][player.x]='.';
  player.x=nx; player.y=ny;
  map[player.y][player.x]='@';
  drawMap();
}

function useItem(){let idx=player.bag.indexOf("薬草");if(idx>=0){player.hp+=5;player.bag.splice(idx,1);log("薬草でHP+5！（HP:"+player.hp+"）");} else{log("薬草がない！");} updateStatus();}

generateMap(); drawMap();
</script>

</body>
</html>
