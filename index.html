<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Stardust Survivor</title>
    <style>
        body {
            margin: 0;
            background-color: #0d0d1a;
            color: #fff;
            font-family: 'Courier New', Courier, monospace;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
        }
        canvas {
            border: 2px solid #555;
            background-color: #000;
        }
        .ui {
            text-align: center;
            margin-top: 10px;
        }
        .ui-element {
            margin: 5px;
            padding: 5px;
            border: 1px solid #aaa;
            cursor: pointer;
            background-color: rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body>
    <canvas id="gameCanvas" width="800" height="600"></canvas>
    <div id="uiContainer" class="ui">
        <h1 id="gameTitle">Stardust Survivor</h1>
        <p id="gameMessage">Press WASD to Move, any key to Start</p>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const uiContainer = document.getElementById('uiContainer');
        const gameMessage = document.getElementById('gameMessage');

        // ==== ゲーム設定 ====
        const GAME_STATE = {
            TITLE: 0,
            PLAYING: 1,
            LEVEL_UP: 2,
            GAME_OVER: 3
        };
        let gameState = GAME_STATE.TITLE;

        // ==== ゲームオブジェクト ====
        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            size: 20,
            speed: 5,
            health: 100,
            maxHealth: 100,
            xp: 0,
            level: 1,
            shotsPerSecond: 2,
        };

        let enemies = [];
        let bullets = [];
        let xpGems = [];
        let lastBulletTime = 0;

        // ✅ 矢印キー → WASD に変更
        const keys = { w: false, a: false, s: false, d: false };

        // ==== キー入力 ====
        window.addEventListener('keydown', (e) => {
            if (gameState === GAME_STATE.TITLE) {
                startGame();
            }
            if (keys.hasOwnProperty(e.key.toLowerCase())) { // 小文字化して比較
                keys[e.key.toLowerCase()] = true;
            }
        });

        window.addEventListener('keyup', (e) => {
            if (keys.hasOwnProperty(e.key.toLowerCase())) {
                keys[e.key.toLowerCase()] = false;
            }
        });

        // ==== ゲーム制御 ====
        function startGame() {
            gameState = GAME_STATE.PLAYING;
            uiContainer.style.display = 'none';
            resetGame();
            lastBulletTime = Date.now();
            requestAnimationFrame(gameLoop);
        }

        function resetGame() {
            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.health = player.maxHealth;
            player.xp = 0;
            player.level = 1;
            player.shotsPerSecond = 2;
            enemies = [];
            bullets = [];
            xpGems = [];
        }

        function gameOver() {
            gameState = GAME_STATE.GAME_OVER;
            uiContainer.style.display = 'block';
            gameMessage.textContent = `GAME OVER. Score: ${player.xp}. Press any key to restart.`;
        }

        function levelUp() {
            gameState = GAME_STATE.LEVEL_UP;
            uiContainer.style.display = 'block';
            uiContainer.innerHTML = `
                <h2>Level Up!</h2>
                <div class="ui-element" onclick="selectUpgrade('firerate')">Increase Fire Rate</div>
                <div class="ui-element" onclick="selectUpgrade('speed')">Increase Speed</div>
                <div class="ui-element" onclick="selectUpgrade('health')">Increase Max Health</div>
            `;
        }

        function selectUpgrade(upgrade) {
            switch (upgrade) {
                case 'firerate':
                    player.shotsPerSecond += 0.5;
                    break;
                case 'speed':
                    player.speed += 1;
                    break;
                case 'health':
                    player.maxHealth += 25;
                    player.health = player.maxHealth;
                    break;
            }
            gameState = GAME_STATE.PLAYING;
            uiContainer.style.display = 'none';
            lastBulletTime = Date.now();
        }

        // ==== ゲームループ ====
        function gameLoop(timestamp) {
            if (gameState === GAME_STATE.PLAYING) {
                update();
                draw();
            } else if (gameState === GAME_STATE.GAME_OVER) {
                draw();
            } else if (gameState === GAME_STATE.LEVEL_UP) {
                draw();
            }
            requestAnimationFrame(gameLoop);
        }

        // ==== 更新処理 ====
        function update() {
            // プレイヤーの移動 (WASD)
            if (keys.w) player.y -= player.speed;
            if (keys.s) player.y += player.speed;
            if (keys.a) player.x -= player.speed;
            if (keys.d) player.x += player.speed;

            // 画面外に出ないように
            player.x = Math.max(0, Math.min(canvas.width, player.x));
            player.y = Math.max(0, Math.min(canvas.height, player.y));

            // 自動攻撃
            const now = Date.now();
            if (now - lastBulletTime > 1000 / player.shotsPerSecond) {
                if (enemies.length > 0) {
                    const targetEnemy = enemies[0];
                    const angle = Math.atan2(targetEnemy.y - player.y, targetEnemy.x - player.x);
                    bullets.push({
                        x: player.x,
                        y: player.y,
                        angle: angle,
                        speed: 7
                    });
                }
                lastBulletTime = now;
            }

            // 敵の生成
            if (Math.random() < 0.05) {
                const side = Math.floor(Math.random() * 4);
                let x, y;
                if (side === 0) { x = Math.random() * canvas.width; y = -20; }
                if (side === 1) { x = Math.random() * canvas.width; y = canvas.height + 20; }
                if (side === 2) { x = -20; y = Math.random() * canvas.height; }
                if (side === 3) { x = canvas.width + 20; y = Math.random() * canvas.height; }
                enemies.push({ x: x, y: y, size: 15, speed: 2, health: 10 });
            }

            // 敵の移動とプレイヤーとの衝突判定
            enemies.forEach(enemy => {
                const angle = Math.atan2(player.y - enemy.y, player.x - enemy.x);
                enemy.x += Math.cos(angle) * enemy.speed;
                enemy.y += Math.sin(angle) * enemy.speed;

                const dist = Math.sqrt((enemy.x - player.x) ** 2 + (enemy.y - player.y) ** 2);
                if (dist < enemy.size + player.size) {
                    player.health -= 1;
                    if (player.health <= 0) {
                        gameOver();
                    }
                }
            });

            // 弾丸の移動と敵との衝突
            bullets.forEach(bullet => {
                bullet.x += Math.cos(bullet.angle) * bullet.speed;
                bullet.y += Math.sin(bullet.angle) * bullet.speed;
            });
            bullets = bullets.filter(b => b.x > -10 && b.x < canvas.width + 10 && b.y > -10 && b.y < canvas.height + 10);

            for (let i = enemies.length - 1; i >= 0; i--) {
                for (let j = bullets.length - 1; j >= 0; j--) {
                    const enemy = enemies[i];
                    const bullet = bullets[j];
                    const dist = Math.sqrt((enemy.x - bullet.x) ** 2 + (enemy.y - bullet.y) ** 2);
                    if (dist < enemy.size) {
                        enemy.health -= 10;
                        bullets.splice(j, 1);
                        if (enemy.health <= 0) {
                            xpGems.push({ x: enemy.x, y: enemy.y, size: 5 });
                            enemies.splice(i, 1);
                        }
                        break;
                    }
                }
            }

            // 経験値ジェムの取得
            xpGems.forEach((gem, i) => {
                const dist = Math.sqrt((gem.x - player.x) ** 2 + (gem.y - player.y) ** 2);
                if (dist < gem.size + player.size) {
                    player.xp += 10;
                    xpGems.splice(i, 1);
                    if (player.xp >= player.level * 100) {
                        player.level++;
                        levelUp();
                    }
                }
            });
        }

        // ==== 描画処理 ====
        function draw() {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            // プレイヤー
            ctx.fillStyle = '#00aaff';
            ctx.fillRect(player.x - player.size / 2, player.y - player.size / 2, player.size, player.size);

            // 敵
            ctx.fillStyle = '#ff0055';
            enemies.forEach(enemy => {
                ctx.fillRect(enemy.x - enemy.size / 2, enemy.y - enemy.size / 2, enemy.size, enemy.size);
            });

            // 弾丸
            ctx.fillStyle = '#00ffaa';
            bullets.forEach(bullet => {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 3, 0, Math.PI * 2);
                ctx.fill();
            });

            // 経験値ジェム
            ctx.fillStyle = '#ffaa00';
            xpGems.forEach(gem => {
                ctx.beginPath();
                ctx.arc(gem.x, gem.y, gem.size, 0, Math.PI * 2);
                ctx.fill();
            });

            // UI
            ctx.fillStyle = '#fff';
            ctx.font = '16px "Courier New"';
            ctx.fillText(`Health: ${player.health}/${player.maxHealth}`, 10, 20);
            ctx.fillText(`Level: ${player.level}`, 10, 40);
            ctx.fillText(`XP: ${player.xp}`, 10, 60);
        }
    </script>
</body>
</html>
